<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: agent.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: agent.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
* @author Rafael Vidaurre
* @requires Utils
* @requires TaskDefinition
* @module Agent
*/

'use strict';

var _, utils, TaskDefinition;

_ = require('lodash');
utils = require('./utils');
TaskDefinition = require('./task-definition');

/**
* @class
* @param {string} id Arbitrary value which identifies an agent instance
*/
function Agent (id) {
  /**
  * Determines wether the agent's config has been applied or not
  */
  this._applied = false;

  /**
  * List of functions which modify the Agent's configuration (provided by setup())
  * @private
  */
  this._configCallbacks = [];

  /**
  * Formatted execution plan created based on the agent's config object
  * @private
  */
  this._plan = null;

  /**
  * Set of task instances for this agent
  * @private
  */
  this._taskDefinitions = {};

  /**
  * Agent's configuration object (set by running all configCallback functions)
  * @private
  */
  this._config = {
    plan: []
  };

  /**
  * Routines defined at agent-level, these override scraper-level routines
  */
  this._routines = {};

  /**
  * Id by which an agent is identified
  */
  this.id = id;
}

/**
* Run functions passed via config(), thus applying their config logic
* @private
*/
Agent.prototype._applyConfigCallbacks = function () {
  var _this = this;
  _.each(_this._configCallbacks, function (configCallback) {
    configCallback(_this._config);
  });
};

/**
* Turns every element in the execution plan into an array for type consistency
* @private
*/
Agent.prototype._formatPlan = function () {
  var _this, formattedPlan, currentGroup, formattedGroup, formattedTaskObj;

  _this = this;
  formattedPlan = [];

  if (_this._config.plan.length &lt;= 0) {
    throw new Error('Agent ' + _this.id + ' has no execution plan, use the config object provided' +
      ' by the setup method to define an execution plan');
  }

  // Turn each tier into an array
  _.each(this._config.plan, function (taskGroup) {
    currentGroup = _.isArray(taskGroup) ? taskGroup : [taskGroup];
    formattedGroup = [];

    // Turn each element in the array into an object
    _.each(currentGroup, function (taskObj) {
      formattedTaskObj = {};

      if (_.isString(taskObj)) {
        formattedTaskObj.taskId = taskObj;
      } else {
        formattedTaskObj = taskObj;
      }

      formattedGroup.push(formattedTaskObj);
    });

    formattedPlan.push(formattedGroup);
  });

  this._plan = formattedPlan;
};

/**
* Applies all task definitions
* @private
*/
Agent.prototype._applyTaskDefinitions = function () {
  _.each(this._taskDefinitions, function (taskDefinition) {
    taskDefinition._applySetup();
  });
};

/**
* Applies all necessary processes regarding the setup stage of the agent
* @private
*/
Agent.prototype._applySetup = function () {
  if (this._applied) {
    return;
  }
  this._applyConfigCallbacks();
  this._applyTaskDefinitions();
  this._formatPlan();
  this._applied = true;
};

/**
* Saves a configuration function into the config callbacks array
* @param {function} cbConfig method which modifies the agent's config object (passed as argument)
*/
Agent.prototype.setup = function (cbConfig) {
  if (!_.isFunction(cbConfig)) {
    throw new Error('Setup argument must be a function');
  }

  this._configCallbacks.push(cbConfig);

  return this;
};

/**
* Creates or retrieves a task for a given task id
* @param {string} taskId id which identifies the task
* @private
* @return {TaskDefinition}
*/
Agent.prototype.task = function (taskId) {
  if (!utils.hasKey(this._taskDefinitions, taskId)) {
    this._taskDefinitions[taskId] = new TaskDefinition(taskId);
  }

  return this._taskDefinitions[taskId];
};

/**
* Creates an agent-wide routine which will be available for all agents
* @param {string} routineName name of the routine
* @param {array} array of taskIds which the routine will include
*/
Agent.prototype.routine = function (routineName, taskIds) {
  if (!_.isArray(taskIds)) {
    throw new Error('An array of task Ids must be passed to the routine method');
  }

  if (!_.isString(routineName)) {
    throw new Error('Routine name must be a string');
  }

  this._routines[routineName] = taskIds;

  return this;
};


module.exports = Agent;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-Agent.html">Agent</a></li><li><a href="module-Http.html">Http</a></li><li><a href="module-Job.html">Job</a></li><li><a href="module-Options.html">Options</a></li><li><a href="module-Scraper.html">Scraper</a></li><li><a href="module-Task.html">Task</a></li><li><a href="module-TaskDefinition.html">TaskDefinition</a></li><li><a href="module-Utils.html">Utils</a></li><li><a href="module-Yakuza.html">Yakuza</a></li><li><a href="module-YakuzaBase.html">YakuzaBase</a></li></ul><h3>Classes</h3><ul><li><a href="module-Agent-Agent.html">Agent</a></li><li><a href="module-Http-Http.html">Http</a></li><li><a href="module-Job-Job.html">Job</a></li><li><a href="module-Options-Options.html">Options</a></li><li><a href="module-Scraper-Scraper.html">Scraper</a></li><li><a href="module-TaskDefinition-TaskDefinition.html">TaskDefinition</a></li><li><a href="module-Task-Task.html">Task</a></li><li><a href="module-YakuzaBase-YakuzaBase.html">YakuzaBase</a></li></ul><h3>Global</h3><ul><li><a href="global.html#defaults">defaults</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-beta2</a> on Wed Mar 11 2015 18:10:11 GMT-0300 (CLST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
